# ğŸ” Auditoria KyrieOS v2 - Stack Real - 2026-01-27

## Stack Identificada

- **Frontend:** `src/app` - Next.js 14+ (App Router)
- **Backend API:** `intelligence-engine/` - FastAPI
- **Database:** Supabase (Schema verificado via `src/types/supabase.ts`)
- **AI Layer:** `intelligence-engine/agents` - Custom Python Agents (nÃ£o CrewAI
  explicitamente, mas estrutura similar)

## Estrutura de Pastas

```
D:\1. LUCCAS\aplicativos ai\KyrieOS\
â”œâ”€â”€ intelligence-engine/   # FastAPI + AI Agents
â”‚   â”œâ”€â”€ agents/            # LÃ³gica dos Agentes (ex: cfo_agent.py)
â”‚   â”œâ”€â”€ routes/            # Endpoints da API
â”‚   â””â”€â”€ main.py            # Entrypoint FastAPI
â”œâ”€â”€ src/                   # Frontend Next.js
â”‚   â”œâ”€â”€ app/               # Rotas (App Router)
â”‚   â”œâ”€â”€ components/        # Componentes UI
â”‚   â””â”€â”€ types/             # DefiniÃ§Ãµes TS (incluindo Supabase)
â””â”€â”€ supabase/              # ConfiguraÃ§Ãµes DB
    â””â”€â”€ migrations/        # SQL Migrations
```

## Resumo Executivo

- **AderÃªncia Geral aos PRDs:** 10-15% (Melhor que a v1, mas ainda com grandes
  gaps estruturais)
- **PRD-001 (Rentabilidade):** ğŸŸ¡ 30% implementado (LÃ³gica do Agente CFO existe
  em Python, mas faltam tabelas no DB e UI completa)
- **PRD-002 (Portal Cliente):** ğŸ”´ 5% implementado (Apenas rota `/report`
  embrionÃ¡ria, sem autenticaÃ§Ã£o de cliente ou features do portal)
- **PRD-003 (IntegraÃ§Ãµes):** ğŸ”´ 0% implementado (CÃ³digos de integraÃ§Ã£o nÃ£o
  encontrados)
- **Branding:** ğŸ”´ 5% implementado (ConfiguraÃ§Ã£o Tailwind padrÃ£o, sem tokens
  Kyrie)

---

## Supabase Schema (via `src/types/supabase.ts`)

### Tabelas Encontradas

| Tabela                   | Relacionada a PRD | ObservaÃ§Ãµes                                                     |
| ------------------------ | ----------------- | --------------------------------------------------------------- |
| `issues`                 | Core / PRD-001    | Tabela padrÃ£o de tarefas, com `technical_effort_score`.         |
| `projects`               | Core              | Apenas campos bÃ¡sicos (`identifier`, `name`). Falta financeiro. |
| `jobs`                   | AI Layer          | Tabela para fila de execuÃ§Ã£o dos agentes (migraÃ§Ã£o `20260126`). |
| `workspaces`, `profiles` | Core              | Estrutura base de multi-tenancy e usuÃ¡rios.                     |

### Tabelas CrÃ­ticas Faltantes (Referenciadas no CÃ³digo mas nÃ£o no Schema)

1. **`contracts`**: O arquivo `cfo_agent.py` faz query nesta tabela
   (`client_name`, `monthly_value`, `hourly_cost`), mas ela **nÃ£o existe** no
   arquivo de tipos gerado. Isso causarÃ¡ erro em runtime.
2. **`ai_actions`**: Referenciada no `cfo_agent.py` para logar alertas, mas
   ausente nos tipos.

---

## Frontend Next.js

### Estrutura de Rotas Identificada

```
src/app/
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ [workspaceSlug]/
â”‚   â”‚   â”œâ”€â”€ [projectIdentifier] # View de Projetos/Tasks
â”‚   â”‚   â”œâ”€â”€ report/             # RelatÃ³rio (PossÃ­vel MVP de Portal?)
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â””â”€â”€ actions.ts              # Server Actions (Create Issue, Trigger CFO)
```

### Componentes Implementados vs PRDs

| Componente PRD     | Encontrado? | Status                                                               |
| ------------------ | ----------- | -------------------------------------------------------------------- |
| **Rentabilidade**  | Parcial     | `CFOAlertBanner` e `CFOSection` existem e chamam o backend AI.       |
| **Portal Cliente** | NÃ£o         | NÃ£o hÃ¡ componentes de timeline, aprovaÃ§Ãµes ou "Client View" robusta. |
| **IntegraÃ§Ãµes**    | NÃ£o         | NÃ£o hÃ¡ telas de configuraÃ§Ã£o de chaves de API.                       |

### Design System

- **Tailwind Config:** PadrÃ£o (`module.exports = { theme: { extend: {} } }`).
- **Cores:** As cores da marca (`#7C3AED`, `#F97316`) nÃ£o estÃ£o configuradas
  como tokens.

---

## FastAPI + AI Layer (`intelligence-engine`)

### Arquitetura

- **Server:** FastAPI rodando (provavelmente) em `localhost:8000`.
- **Agents:** LÃ³gica customizada em Python puro (sem CrewAI framework explÃ­cito
  instalado no `requirements.txt` visÃ­vel, mas seguindo padrÃ£o de agentes).

### Agents Implementados

| Agent         | Arquivo        | Responsabilidade                                     | Status                                                              |
| ------------- | -------------- | ---------------------------------------------------- | ------------------------------------------------------------------- |
| **CFO Agent** | `cfo_agent.py` | Calcular VariÃ¢ncia (Custo Real vs Receita Contrato). | ğŸŸ¡ Implementado, mas depende de tabelas inexistentes (`contracts`). |

### LÃ³gica CFO Identificada

O agente tenta:

1. Buscar contratos ativos (`SELECT * FROM contracts`).
2. Obter resumo de worklogs via RPC `get_worklog_summary`.
3. Calcular `(Horas * Custo Hora) - Valor Mensal`.
4. Inserir alerta em `ai_actions` se variÃ¢ncia > 10%.

---

## ğŸ¯ RecomendaÃ§Ãµes PrioritÃ¡rias

### ğŸš¨ Alta Prioridade (CorreÃ§Ãµes Imediatas)

1. **Criar Tabela `contracts`:** O cÃ³digo do agente CFO vai falhar sem essa
   tabela.
   - Campos necessÃ¡rios: `id`, `workspace_id`, `client_name`, `monthly_value`,
     `hourly_cost`, `is_active`.
2. **Criar Tabela `ai_actions`:** NecessÃ¡ria para armazenar os outputs do
   agente.
3. **Sincronizar Tipos:** Rodar `supabase gen types` apÃ³s criar as tabelas para
   atualizar o frontend.

### ğŸ”¨ MÃ©dia Prioridade (Funcionalidades)

1. **Popular Dados:** NÃ£o hÃ¡ mecanismo de input para "Contratos" no frontend. Ã‰
   necessÃ¡rio criar uma tela em `Settings` para cadastrar os valores dos
   contratos.
2. **Branding:** Adicionar as cores Kyrie no `tailwind.config.js` para sair do
   visual padrÃ£o.

### ğŸ”® Baixa Prioridade (Futuro)

1. **IntegraÃ§Ã£o Real de Horas:** O RPC `get_worklog_summary` precisa ler de
   algum lugar. Se nÃ£o houver integraÃ§Ã£o com Clockify (PRD-003), ele lerÃ¡ apenas
   worklogs internos do Kyrie, que podem estar incompletos.

---

## ğŸ“Š MÃ©tricas de Cobertura Atualizadas

| Ãrea               | Itens PRD | Implementados | Cobertura |
| ------------------ | --------- | ------------- | --------- |
| **Rentabilidade**  | 10        | 3             | 30%       |
| **Portal Cliente** | 8         | 0             | 0%        |
| **IntegraÃ§Ãµes**    | 8         | 0             | 0%        |
| **Infra AI**       | 5         | 4             | 80%       |

---

_Auditoria v2 realizada em: 2026-01-27_ _Verificado: CÃ³digo Fonte (Python/TS) e
DefiniÃ§Ãµes de Tipo (DB)_
