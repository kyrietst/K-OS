import { createClient } from '@/lib/supabase/server'
import { notFound } from 'next/navigation'
import IssueList from '@/components/issues/issue-list'
import CreateIssueModal from '@/components/issues/create-issue-modal'
import KanbanBoard from '@/components/kanban/kanban-board'
import { Link, Button } from '@heroui/react'
import { Settings } from 'lucide-react'
import IssueDetailsModal from '@/components/issues/issue-details-modal'
import { getProjectAnalytics } from '@/features/projects/actions/get-project-analytics'
import { ProjectAnalytics } from '@/components/analytics/project-analytics'
import CyclesView from '@/components/cycles/cycles-view'
import ModulesView from '@/components/modules/modules-view'

export default async function ProjectPage({
  params,
  searchParams
}: {
  params: Promise<{ workspaceSlug: string, projectIdentifier: string }>
  searchParams: Promise<{ view?: string; issueId?: string }>
}) {
  const { workspaceSlug, projectIdentifier } = await params
  const { view = 'overview', issueId } = await searchParams
  const supabase = await createClient()

  // 1. Get Workspace
  const { data: workspace } = await supabase
    .from('workspaces')
    .select('id, name')
    .eq('slug', workspaceSlug)
    .single()

  if (!workspace) return notFound()

  // 2. Get Project
  const { data: project } = await supabase
    .from('projects')
    .select('*')
    .eq('workspace_id', workspace.id)
    .eq('identifier', projectIdentifier.toUpperCase()) 
    .single()

  if (!project) return notFound()

  // 3. Fetch Data in Parallel
  const [
    { data: issues },
    analytics,
    { data: profiles },
    { data: cycles },
    { data: modules }
  ] = await Promise.all([
    // Issues
    supabase
      .from('issues')
      .select(`
          *,
          assignee:assignee_id(email, full_name)
      `)
      .eq('project_id', project.id)
      .order('sequence_id', { ascending: false }),
    
    // Analytics
    getProjectAnalytics(project.id),

    // Profiles
    supabase
      .from('profiles')
      .select('*')
      .in('id', (
        await supabase
          .from('workspace_members')
          .select('user_id')
          .eq('workspace_id', workspace.id)
      ).data?.map(m => m.user_id) || []),

    // Cycles
    supabase
      .from('cycles')
      .select('*')
      .eq('project_id', project.id)
      .order('start_date', { ascending: true }),

    // Modules
    supabase
      .from('modules')
      .select('*')
      .eq('project_id', project.id)
      .order('created_at', { ascending: false })
  ])

  // 5. Selected Issue
  let selectedIssue = null
  if (issueId) {
    const { data } = await supabase
      .from('issues')
      .select('*, assignee:profiles!issues_assignee_id_fkey(*)')
      .eq('id', issueId)
      .single()
    
    if (data) selectedIssue = data
  }

  const currentView = view

  return (
    <div className="flex flex-col h-full bg-transparent">
       {/* Header */}
       <div className="flex flex-col gap-4 p-6 border-b border-white/5 bg-content1/50 backdrop-blur-md z-10">
           <div className="flex items-center justify-between">
               <div>
                   <div className="flex items-center gap-2 text-sm text-default-500 mb-1">
                        <span>{workspace.name}</span>
                        <span>/</span>
                        <span>Projects</span>
                   </div>
                   <h1 className="text-2xl font-bold text-foreground">{project.name}</h1>
               </div>
               <div className="flex items-center gap-3">
                   <CreateIssueModal 
                        workspaceSlug={workspaceSlug} 
                        projectIdentifier={projectIdentifier}
                        projectId={project.id}
                        workspaceId={workspace.id}
                   />
                   <Button isIconOnly variant="secondary" className="bg-content2/50">
                        <Settings size={18} />
                   </Button>
               </div>
           </div>

           {/* View Switcher & Filters */}
           <div className="flex items-center justify-between">
               <div className="flex bg-content2/30 p-1 rounded-lg border border-white/5">
                   <Link href={`?view=overview`}>
                       <div className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${view === 'overview' ? 'bg-content1 text-foreground shadow-sm' : 'text-default-500 hover:text-default-300'}`}>
                           Overview
                       </div>
                   </Link>
                   <Link href={`?view=board`}>
                       <div className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${view === 'board' ? 'bg-content1 text-foreground shadow-sm' : 'text-default-500 hover:text-default-300'}`}>
                           Board
                       </div>
                   </Link>
                   <Link href={`?view=list`}>
                       <div className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${view === 'list' ? 'bg-content1 text-foreground shadow-sm' : 'text-default-500 hover:text-default-300'}`}>
                           List
                       </div>
                   </Link>
                   <Link href={`?view=cycles`}>
                       <div className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${view === 'cycles' ? 'bg-content1 text-foreground shadow-sm' : 'text-default-500 hover:text-default-300'}`}>
                           Cycles
                       </div>
                   </Link>
               </div>
           </div>
       </div>

       {/* Content Area */}
       <div className="flex-1 overflow-hidden relative">
            {view === 'overview' ? (
               <div className="h-full overflow-y-auto p-6">
                    <ProjectAnalytics data={analytics} />
               </div>
            ) : view === 'board' ? (
                <div className="h-full w-full overflow-hidden">
                <KanbanBoard 
                        initialIssues={issues || []} 
                        workspaceSlug={workspaceSlug}
                        projectIdentifier={projectIdentifier}
                        projectId={project.id}
                    />
                </div>
            ) : view === 'cycles' ? (
                 <div className="p-6">
                    <CyclesView 
                       cycles={cycles || []} 
                       issues={issues || []} 
                       workspaceSlug={workspaceSlug}
                       projectIdentifier={projectIdentifier}
                       projectId={project.id}
                    />
                 </div>
            ) : (
                <div className="h-full overflow-y-auto">
                    <IssueList issues={issues || []} projectIdentifier={project.identifier} />
                </div>
           )}
       </div>

       <IssueDetailsModal 
         issue={selectedIssue} 
         isOpen={!!selectedIssue} 
         workspaceSlug={workspaceSlug}
         projectIdentifier={projectIdentifier}
         profiles={profiles || []}
         cycles={cycles || []}
         modules={modules || []}
       />
    </div>
  )
}

